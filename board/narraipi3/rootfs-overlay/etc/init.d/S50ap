#!/bin/sh
#
# AP + DHCP init script (Buildroot)
#

STA_IF="wlan0"
AP_IF="ap0"

DEFAULT_CHANNEL=11

HOSTAPD_CONF="/etc/hostapd.conf"
DNSMASQ_CONF="/etc/dnsmasq.conf"

HOSTAPD_PID="/var/run/hostapd.pid"
DNSMASQ_PID="/var/run/dnsmasq.pid"

freq_to_channel() {
    freq="$1"

    # 2.4 GHz
    if [ "$freq" -ge 2412 ] && [ "$freq" -le 2472 ]; then
        echo $(( (freq - 2407) / 5 ))
        return
    fi

    # 5 GHz
    if [ "$freq" -ge 5000 ] && [ "$freq" -le 5900 ]; then
        echo $(( (freq - 5000) / 5 ))
        return
    fi

    echo "${DEFAULT_CHANNEL}"
}

get_sta_channel() {
    freq="$(iw dev "${STA_IF}" link 2>/dev/null \
        | awk '/freq:/ {
            split($2, f, ".")
            print f[1]
            exit
        }')"

    if [ -n "$freq" ]; then
        freq_to_channel "$freq"
    else
        echo "${DEFAULT_CHANNEL}"
    fi
}

set_hostapd_channel() {
    conf="$1"
    channel="$2"

    # If channel= exists, replace it
    if grep -q '^channel=' "$conf"; then
        sed -i "s/^channel=.*/channel=${channel}/" "$conf"
    else
        # Otherwise append it
        echo "channel=${channel}" >> "$conf"
    fi
}

start_ap() {
    echo "Starting AP..."

    # Check if STA interface exists
    if ! ip link show "${STA_IF}" >/dev/null 2>&1; then
        echo "STA interface ${STA_IF} not found, AP not started"
        exit 0
    fi

    # Create AP interface if missing
    if ! ip link show "${AP_IF}" >/dev/null 2>&1; then
        iw dev "${STA_IF}" interface add "${AP_IF}" type __ap
    fi

    # Bring AP interface up
    ip link set "${AP_IF}" up

    # Determine channel
    CHANNEL="$(get_sta_channel)"
    # Update channel used
    set_hostapd_channel "${HOSTAPD_CONF}" "${CHANNEL}"

    # Start hostapd
    hostapd "${HOSTAPD_CONF}" -B -P "${HOSTAPD_PID}" || {
        echo "hostapd failed"
        exit 1
    }

    # Start dnsmasq
    # dnsmasq --conf-file="${DNSMASQ_CONF}" --pid-file="${DNSMASQ_PID}"

    echo "AP started"
}

stop_ap() {
    echo "Stopping AP..."

    if [ -f "${DNSMASQ_PID}" ]; then
        kill "$(cat "${DNSMASQ_PID}")" 2>/dev/null
        rm -f "${DNSMASQ_PID}"
    fi

    if [ -f "${HOSTAPD_PID}" ]; then
        kill "$(cat "${HOSTAPD_PID}")" 2>/dev/null
        rm -f "${HOSTAPD_PID}"
    fi

    if ip link show "${AP_IF}" >/dev/null 2>&1; then
        ip link set "${AP_IF}" down
        iw dev "${AP_IF}" del
    fi

    echo "AP stopped"
}

case "$1" in
    test)
        get_sta_channel
        ;;
    start)
        start_ap
        ;;
    stop)
        stop_ap
        ;;
    restart)
        stop_ap
        sleep 1
        start_ap
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac

exit 0